<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://kit.fontawesome.com/470d32f9d6.js"></script>
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <title>Friend Finder</title>
</head>
<body>
    <div class="container my-3">
        <div class="container">
            <div class="jumbotron">
                <div class="mx-auto">
                    <h1 class="display-4">So What Kind of Friend Are You?</h1>
                </div>
                <hr class="my-4">

                <p class="lead">Complete this survey so that Friend Finder can understand what kind of friend you are and what kind of friend you're looking for!</p>
                
                <a class="btn btn-primary btn-lg" href="/" role="button"><i class="fas fa-home"></i></a>
        </div>

        <form id="get-match">
            <div>
                <p>Rate how true this statement is for you on a scale of 1-5, 
                    with 1 indicating, "No way, Jose; not true for me at all!!" 
                    and 5 indicating, "Oh yes, that's totally me."</p>
            </div>

            <div class="form-group">
                <label for="name" name="name" class="col-form-label">My name is:</label>
                <input type="text" class="form-control" id="name">         
            </div>

            <div class="form-group">
                <label for="photo" name="photo" class="col-form-label">My Photo:</label>
                <input type="url" class="form-control" id="photo" required>         
            </div>

            <div class="form-group">
                <label for="q-1" name="question1" class="col-form-label">I'm an introverted person.</label>
                <select class="form-control" id="q-1" required>
                    <option></option>
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                </select>                
            </div>
        
            <div class="form-group">
                <label for="q-2" name="question2" class="col-form-label">I like doing activities with friends instead of just sitting around shooting the s***.</label>
                <select class="form-control" id="q-2" required>
                    <option></option>
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>                        
                    <option>4</option>
                    <option>5</option>                
                </select>
            </div>
        
            <div class="form-group">
                <label for="q-3" name="question3" class="col-form-label">I am very open with my emotions (aka I'm gushy / warm and fuzzy / emotional).</label>
                <select class="form-control" id="q-3" required>
                    <option></option>
                    <option>1</option>
                    <option>2</option>                    
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>                                    
                </select>
            </div>  
        
            <div class="form-group">
                <label for="q-4" name="question4" class="col-form-label">I'm a chatty Kathy.</label>
                <select class="form-control" id="q-4" required>
                    <option></option>
                    <option>1</option>                        
                    <option>2</option>                    
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>                
                </select>
            </div>
        
            <div class="form-group">
                <label for="q-5" name="question5" class="col-form-label">I like to be intellectual and share in that with friends.</label>
                <select class="form-control" id="q-5" required>                    
                    <option></option>
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>                        
                    <option>4</option>
                    <option>5</option>                
                </select>
            </div>
        
            
            <div class="form-group">
                <label for="q-6" name="question6" class="col-form-label">I have loads of time for my friends.</label>
                <select class="form-control" id="q-6" required>
                    <option></option>
                    <option>1</option>
                    <option>2</option>                    
                    <option>3</option>                        
                    <option>4</option>
                    <option>5</option>                
                </select>
            </div>
        
        
            <div class="form-group">
                <label for="q-7" name="question7" class="col-form-label">I tend to see and talk to the friends I have often.</label>
                <select class="form-control" id="q-7" required>
                    <option></option>
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>                
                </select>
            </div>
         
            <div class="form-group">
                <label for="q-8" name="question8" class="col-form-label">I think it's always better when you're doing something with a buddy.</label>
                <select class="form-control" id="q-8" required>                        
                    <option></option>
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>                
                </select>
            </div>
        
            <div class="form-group">
                <label for="q-9" name="question9" class="col-form-label">I keep close frienships with a few people instead of having less close relationships with lots of people.</label>
                <select class="form-control" id="q-9" required>
                    <option></option>
                    <option>1</option>                        
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>                
                </select>                
            </div>
        
            <div class="form-group">
                <label for="q-10" name="question10" class="col-form-label">My friends are often unique and interesting, maybe even weird, vs. trendy, in-the-know, etc.</label>
                <select class="form-control" id="q-10" required>
                    <option></option>
                    <option>1</option>                        
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>                
                </select>
            </div>

            <button class="btn btn-primary btn-lg" type="submit">See Results!</button>
        </form>

        <div>
            <h4>See all Possible Friends</h4>
            <ul>
                <li><a href="/api/friends" target="_blank">Friends Data (API)</a></li>
            </ul>
        </div>
    </div>
    
</body>

<script type="text/javascript">
    $(document).ready(function() {

    // function which will get survey scores for current site visitor
    function getCurrentSurveyScores() {
        var currentScores = [];
        
        for (var i = 1; i <= 10; i++) {
             currentScores.push($("#q-" + i).val().trim());
        }

        // console.log(currentScores);
        return currentScores;
    }

    // function which will get all responses of current site visitor (calls score function above)
    function getCurrentSurveyResults() {
        var currentRes = {
            name: $("#name").val().trim(),
            photo: $("#photo").val().trim()
        };
        
        currentRes.scores = getCurrentSurveyScores();

        console.log(currentRes);
        return currentRes;
    }

    // function to create a modal showing all best matches of current site visitor
    function showFriends(matchArr, num) {
        // creating the body of the modal
        var matchDisplay = $("<div>").addClass("modal fade match-modal");
        var centerDisplay = $("<div>").addClass("modal-dialog modal-dialog-centered");
        var displayBody = $("<div>").addClass("modal-content modal-body");
        var displayTitle = $("<div>").addClass("modal-header");
        displayTitle.html("<h5 class=modal-title>Best Match(es)</h5>");
        displayBody.append(displayTitle);

        // creating the main content of the modal - the matches
        // if the array of best possible matches (i.e. the array of friends who at some point had least difference in points with the current site visitor) has just 1 friend, just show that friend in the match modal
        // otherwise, loop through this array and add any friend to the modal whose survey score least differs from the current site vistor's
        // if there are multiple friends on the modal, they all have the same difference in points from the current site visitor
        if (matchArr.length === 1) {
            console.log("I, first condition, am running");
            var matchDetails = $("<div>");
            var matchDetails = "<p>" + matchArr[0].name + "</p>";
            matchDetails += "<img src=" + matchArr[0].photo + "/>";
            $(displayBody).append(matchDetails);
        } else {
            for (var i = 0; i < matchArr.length; i++) {
                var matchOption = matchArr[i];
                // console.log(matchOption);

                if (matchOption.totalDifWithNewFriend === num) {
                    
                    var matchDetails = $("<div>");
                    var matchDetails = "<p>" + matchOption.name + "</p>";
                    matchDetails += "<img src=" + matchOption.photo + "/>";
                    $(displayBody).append(matchDetails);
        
                }
            }
        }
        
        // creating the footer of the match modal (with the close button)
        var footerClose = $("<div>").addClass("modal-footer");
        footerClose.html("<button type='button' class='btn btn-primary' data-dismiss='modal'>Close</button>");
        displayBody.append(footerClose);
        centerDisplay.append(displayBody);
        matchDisplay.append(centerDisplay);
        $(matchDisplay).modal('show');
    }
    
    // function for form submission -- main matching functionality 
    $("#get-match").on("submit", function(e) {
        // prevent default, initialize variables for matching logic - 
        // point difference variable to beat (40 is the maximum difference in points any two users could have)
        // array of best possible matches
        // get the current site visitor's scores (using function above) to compare scores of other saved friends with
        e.preventDefault();
        var newestFriend = getCurrentSurveyResults();
        var currentLeastDif = 40;
        var matchesArr = [];

        // add the current site visitor to the json of currently saved friends (so they can possibly be matched with other visitors later)
        // then do the following with the response (which is a json of previously saved friends)
        $.post("/api/friends", newestFriend, function(response) {

            // iterate through each previously saved friend
            // iterate through each of these friend's scores and the current site visitor's scores
            // add the difference (using absolute value) to get the total positive difference in points between each user's scores
            for (var i = 0; i < response.length - 1; i++) {
                var otherFriend = response[i];
                var currentDif = 0;
                for (var j = 0; j < otherFriend.scores.length; j++) {

                    currentDif += Math.abs(newestFriend.scores[j] - otherFriend.scores[j]);
                }

                console.log("round " + i + " currentDif: ", currentDif);

                // if the current total difference is less than or equal to the smallest total difference, add the other friend to array of potential matches for current site visitor
                if (currentDif <= currentLeastDif) {
                    currentLeastDif = currentDif;
                    console.log("This one was closer. New currentLeastDif is: " + currentLeastDif);
                    otherFriend.totalDifWithNewFriend = currentLeastDif;

                    matchesArr.push(otherFriend);
                }
            }

            console.log("Final current least dif is: ", currentLeastDif);
            console.log("Best match(es): ", matchesArr);

            // use the above function for making the match modal to actually get the current site vistor's best match(es)
            showFriends(matchesArr, currentLeastDif);
            // also clear the current site visitor's from the form as the modal pops up so that it is available for new filling out
            $( '#get-match' ).each(function(){
                this.reset();
            });
        })
    });

});

</script>
</html>
